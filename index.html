<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fasal â€” Digital Doctor for Farmers</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ DARK MODE â”€â”€ */
  :root {
    --bg: #0a0a0a;
    --bg2: #111111;
    --bg3: #161616;
    --card: #1a1a1a;
    --card2: #1f1f1f;
    --border: #2a2a2a;
    --accent: #4ecf62;
    --accent2: #30a844;
    --accent3: #8ee89a;
    --warn: #e8c547;
    --danger: #e86060;
    --text: #f0f0f0;
    --muted: #707070;
    --muted2: #444444;
  }
  /* â”€â”€ LIGHT MODE â”€â”€ */
  body.light {
    --bg: #f8f8f8;
    --bg2: #ffffff;
    --bg3: #f2f2f2;
    --card: #ffffff;
    --card2: #f5f5f5;
    --border: #e0e0e0;
    --accent: #27923b;
    --accent2: #1d7a2e;
    --accent3: #5abf6b;
    --warn: #a07800;
    --danger: #c0392b;
    --text: #111111;
    --muted: #777777;
    --muted2: #bbbbbb;
  }

  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; transition: background-color 0.25s, border-color 0.25s, color 0.25s; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ NAV â”€â”€ */
  nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; height: 60px;
    background: var(--bg2); border-bottom: 1px solid var(--border);
    flex-shrink: 0; z-index: 100; position: relative;
  }
  .logo {
    font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--accent);
    display: flex; align-items: center; gap: 10px;
  }
  .logo span { color: var(--text); font-weight: 500; font-size: 0.95rem; opacity: 0.6; margin-left: 4px; }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
  }
  .nav-right { display: flex; align-items: center; gap: 12px; }
  .nav-btn {
    padding: 7px 14px; border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s;
  }
  .nav-btn.outline { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .nav-btn.outline:hover { border-color: var(--accent); color: var(--accent); }
  .nav-btn.primary { background: var(--accent2); color: #fff; }
  .nav-btn.primary:hover { background: var(--accent); }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* Theme toggle */
  .theme-toggle-wrap { display:flex; align-items:center; gap:7px; cursor:pointer; }
  .t-icon { font-size:1rem; line-height:1; }
  .toggle-track {
    width: 38px; height: 21px; background: var(--border);
    border-radius: 11px; border: 1px solid var(--border);
    position: relative; flex-shrink: 0;
  }
  body.light .toggle-track { background: var(--accent3); border-color: var(--accent2); }
  .toggle-thumb {
    position: absolute; top: 2px; left: 2px;
    width: 15px; height: 15px; border-radius: 50%;
    background: var(--muted); transition: transform 0.3s, background 0.3s;
  }
  body.light .toggle-thumb { transform: translateX(17px); background: var(--accent2); }
  .toggle-label { font-size:0.78rem; color:var(--muted); min-width:30px; }

  /* â”€â”€ BODY LAYOUT: sidebar tabs + center â”€â”€ */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  /* â”€â”€ SIDEBAR PANELS â”€â”€ */
  .panel {
    flex-shrink: 0;
    width: 0;
    overflow: hidden;
    background: var(--bg2);
    display: flex;
    flex-direction: column;
    transition: width 0.32s cubic-bezier(0.4,0,0.2,1);
    position: relative;
    z-index: 20;
  }
  .panel.left { border-right: 1px solid var(--border); }
  .panel.right { border-left: 1px solid var(--border); }
  .panel.open { width: 300px; }
  .panel-inner { width: 300px; display:flex; flex-direction:column; height:100%; overflow:hidden; }

  /* â”€â”€ PANEL TOGGLE TABS â”€â”€ */
  .panel-tab {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 30;
    display: flex; align-items: center; justify-content: center;
    width: 22px; height: 64px;
    background: var(--bg2);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    color: var(--muted);
    font-size: 0.7rem;
  }
  .panel-tab:hover { background: var(--card); color: var(--accent); border-color: var(--accent); }
  .panel-tab.left-tab { right: -22px; border-radius: 0 8px 8px 0; border-left: none; }
  .panel-tab.right-tab { left: -22px; border-radius: 8px 0 0 8px; border-right: none; }

  /* â”€â”€ SIDEBAR INTERNALS â”€â”€ */
  .sidebar-header {
    padding: 16px 18px 12px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .sidebar-title {
    font-family: 'Space Mono', monospace; font-size: 0.7rem;
    color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase;
  }
  .tag-pill { font-size: 0.7rem; padding: 3px 9px; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-weight: 500; cursor: pointer; }
  .tag-pill.active { background: var(--accent2); color: #fff; }
  .tag-pill.inactive { background: var(--border); color: var(--muted); }
  .news-filter { padding: 10px 14px; display:flex; gap:6px; flex-wrap:wrap; flex-shrink:0; }

  /* â”€â”€ NEWS SLIDESHOW â”€â”€ */
  .slideshow-wrap {
    position: relative; overflow: hidden; flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  .slides { display:flex; transition: transform 0.5s cubic-bezier(0.4,0,0.2,1); }
  .slide {
    min-width: 100%; padding: 14px 18px;
    background: var(--card); cursor: pointer;
  }
  .slide-tag { font-size: 0.62rem; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:5px; }
  .slide-tag.disease { color: var(--danger); }
  .slide-tag.tip { color: var(--accent); }
  .slide-tag.market { color: var(--warn); }
  .slide-tag.weather { color: #7ec8e3; }
  .slide-title { font-size: 0.84rem; font-weight:500; line-height:1.4; color:var(--text); margin-bottom:6px; }
  .slide-meta { font-size:0.7rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center; }
  .slide-dots { display:flex; gap:5px; justify-content:center; padding:8px; flex-shrink:0; }
  .sdot { width:6px; height:6px; border-radius:50%; background:var(--border); cursor:pointer; transition:background 0.2s, transform 0.2s; }
  .sdot.active { background:var(--accent2); transform:scale(1.3); }
  .slide-arrows { position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; pointer-events:none; padding: 0 4px; }
  .sarrow { pointer-events:all; cursor:pointer; width:22px; height:22px; border-radius:50%; background:var(--bg2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:0.7rem; color:var(--muted); transition:all 0.2s; }
  .sarrow:hover { border-color:var(--accent); color:var(--accent); }

  /* â”€â”€ NEWS LIST (below slideshow) â”€â”€ */
  .news-feed { flex:1; overflow-y:auto; padding:8px 10px 16px; }
  .news-feed::-webkit-scrollbar { width:3px; }
  .news-feed::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  .news-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .news-card::before { content:''; position:absolute; top:0; left:0; width:3px; height:100%; background:var(--accent2); opacity:0; transition:opacity 0.2s; }
  .news-card:hover { border-color: var(--accent2); transform: translateX(2px); }
  .news-card:hover::before { opacity:1; }
  .news-card.alert::before { background:var(--danger); opacity:1; }
  .news-card.warn::before { background:var(--warn); opacity:1; }
  .news-tag { font-size:0.62rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:5px; }
  .news-tag.disease { color:var(--danger); }
  .news-tag.tip { color:var(--accent); }
  .news-tag.market { color:var(--warn); }
  .news-tag.weather { color:#7ec8e3; }
  .news-title { font-size:0.82rem; font-weight:500; line-height:1.4; color:var(--text); margin-bottom:6px; }
  .news-meta { font-size:0.7rem; color:var(--muted); display:flex; justify-content:space-between; }

  /* â”€â”€ CENTER: CHAT â”€â”€ */
  .chat-area {
    flex: 1; display:flex; flex-direction:column; background:var(--bg); overflow:hidden; position:relative;
  }
  .chat-header {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    display:flex; align-items:center; gap:12px; background:var(--bg2); flex-shrink:0;
  }
  .ai-avatar {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--card2), var(--accent2));
    border-radius: 50%; display:flex; align-items:center; justify-content:center;
    font-size: 1.1rem; border: 2px solid var(--accent2); position:relative; flex-shrink:0;
  }
  .ai-avatar::after {
    content:''; position:absolute; bottom:1px; right:1px;
    width:9px; height:9px; border-radius:50%;
    background:var(--accent); border:2px solid var(--bg2);
  }
  .chat-title { font-size:0.97rem; font-weight:600; }
  .chat-subtitle { font-size:0.75rem; color:var(--muted); }
  .chat-messages {
    flex:1; overflow-y:auto; padding:22px; display:flex; flex-direction:column; gap:16px;
  }
  .chat-messages::-webkit-scrollbar { width:4px; }
  .chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

  .msg { display:flex; gap:12px; animation:fadeSlideIn 0.3s ease; }
  @keyframes fadeSlideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }
  .msg.user { flex-direction:row-reverse; }
  .msg-avatar {
    width:34px; height:34px; border-radius:50%; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-size:0.9rem;
  }
  .msg-avatar.ai-av { background:linear-gradient(135deg, var(--card2), var(--accent2)); border:1px solid var(--accent2); }
  .msg-avatar.user-av { background:var(--border); }
  .msg-bubble {
    max-width:72%; padding:12px 16px; border-radius:16px;
    font-size:0.87rem; line-height:1.6;
  }
  .msg.ai .msg-bubble { background:var(--card); border:1px solid var(--border); border-bottom-left-radius:4px; }
  .msg.user .msg-bubble { background:var(--accent2); color:#fff; border-bottom-right-radius:4px; }
  .msg-image-preview {
    width:180px; height:120px;
    background:linear-gradient(135deg, var(--card2), var(--border));
    border-radius:10px; display:flex; align-items:center; justify-content:center;
    font-size:2.5rem; margin-bottom:8px; border:1px solid var(--border);
  }
  .diagnosis-card {
    background:var(--card2); border:1px solid var(--border); border-radius:10px;
    padding:12px; margin-top:8px;
  }
  .diagnosis-tag { font-size:0.7rem; font-weight:600; color:var(--danger); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:4px; }
  .diagnosis-name { font-size:0.95rem; font-weight:600; margin-bottom:6px; }
  .diagnosis-detail { font-size:0.8rem; color:var(--muted); line-height:1.5; }
  .confidence-bar { display:flex; align-items:center; gap:8px; margin-top:8px; }
  .conf-label { font-size:0.72rem; color:var(--muted); }
  .conf-track { flex:1; height:4px; background:var(--border); border-radius:4px; overflow:hidden; }
  .conf-fill { height:100%; background:linear-gradient(90deg, var(--accent2), var(--accent)); border-radius:4px; }
  .typing-indicator { display:flex; align-items:center; gap:4px; padding:4px 0; }
  .typing-dot { width:7px; height:7px; border-radius:50%; background:var(--muted); animation:typingBounce 1.2s infinite; }
  .typing-dot:nth-child(2){animation-delay:0.2s} .typing-dot:nth-child(3){animation-delay:0.4s}
  @keyframes typingBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

  /* Read Aloud */
  .msg-actions { display:flex; align-items:center; gap:6px; margin-top:6px; padding-left:46px; }
  .read-aloud-btn {
    display:flex; align-items:center; gap:5px; font-size:0.72rem; padding:4px 11px;
    border-radius:20px; cursor:pointer; border:1px solid rgba(126,200,227,0.25);
    background:rgba(126,200,227,0.08); color:#7ec8e3;
    font-family:'DM Sans', sans-serif; font-weight:500;
  }
  .read-aloud-btn:hover { background:rgba(126,200,227,0.18); border-color:#7ec8e3; }
  .read-aloud-btn.speaking { border-color:#7ec8e3; background:rgba(126,200,227,0.2); animation:speakPulse 1.5s infinite; }
  @keyframes speakPulse { 0%,100%{box-shadow:0 0 0 0 rgba(126,200,227,0.3)} 50%{box-shadow:0 0 0 5px rgba(126,200,227,0)} }
  .speaker-icon { display:inline-block; }
  .read-aloud-btn.speaking .speaker-icon { animation:speakerBounce 0.5s infinite alternate; }
  @keyframes speakerBounce { from{transform:scale(1)} to{transform:scale(1.3)} }

  /* Upload area */
  .chat-input-area {
    padding:14px 18px; background:var(--bg2); border-top:1px solid var(--border);
    display:flex; justify-content:center; flex-shrink:0;
  }
  .upload-row { display:flex; align-items:center; justify-content:center; width:100%; gap:0; }
  .upload-btn-big {
    display:flex; align-items:center; gap:10px; padding:11px 26px; border-radius:12px;
    background:var(--card); border:1.5px solid var(--border); color:var(--muted);
    font-family:'DM Sans', sans-serif; font-size:0.87rem; font-weight:500; cursor:pointer;
  }
  .upload-btn-big:hover { border-color:var(--accent2); color:var(--accent); background:rgba(78,207,98,0.07); transform:translateY(-1px); }
  .upload-btn-big.active { border-color:var(--accent); color:var(--accent); background:rgba(78,207,98,0.1); }
  .upload-preview {
    display:none; background:var(--card); border:1px solid var(--border); border-radius:10px;
    padding:10px; margin-right:10px; align-items:center; gap:10px;
  }
  .upload-preview.show { display:flex; }
  .preview-thumb {
    width:56px; height:46px; background:var(--card2); border-radius:6px;
    display:flex; align-items:center; justify-content:center; font-size:1.4rem; flex-shrink:0; overflow:hidden;
  }
  .preview-thumb img { width:100%; height:100%; object-fit:cover; border-radius:5px; }
  .preview-info { flex:1; }
  .preview-name { font-size:0.78rem; font-weight:500; }
  .preview-size { font-size:0.7rem; color:var(--muted); }
  .preview-remove { cursor:pointer; color:var(--muted); font-size:1.1rem; padding:4px; }
  .preview-remove:hover { color:var(--danger); }
  .preview-send {
    padding:7px 14px; border-radius:8px; background:var(--accent2); border:none;
    color:#fff; font-family:'DM Sans', sans-serif; font-size:0.8rem; font-weight:600;
    cursor:pointer; white-space:nowrap;
  }
  .preview-send:hover { background:var(--accent); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     7-DAY CARE ROUTINE CARD
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .routine-card {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-top: 10px;
    overflow: hidden;
    animation: fadeSlideIn 0.4s ease 0.1s both;
  }
  .routine-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px;
    background: linear-gradient(90deg, rgba(78,207,98,0.08), transparent);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
  }
  .routine-header:hover { background: linear-gradient(90deg, rgba(78,207,98,0.14), transparent); }
  .routine-header-left { display:flex; align-items:center; gap:9px; }
  .routine-icon-wrap {
    width: 30px; height: 30px; border-radius: 8px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex; align-items: center; justify-content: center; font-size: 1rem;
  }
  .routine-title { font-size: 0.85rem; font-weight: 700; color: var(--text); }
  .routine-subtitle { font-size: 0.68rem; color: var(--muted); }
  .routine-chevron {
    font-size: 0.75rem; color: var(--accent); transition: transform 0.3s;
    width: 22px; height: 22px; display:flex; align-items:center; justify-content:center;
    border-radius: 50%; border: 1px solid rgba(78,207,98,0.25);
  }
  .routine-chevron.open { transform: rotate(180deg); }

  .routine-body { display:none; }
  .routine-body.open { display:block; }

  .day-grid { display: grid; grid-template-columns: 1fr; }
  .day-row {
    display: flex; align-items: center; gap: 11px;
    padding: 9px 14px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    position: relative;
    overflow: hidden;
  }
  .day-row:last-child { border-bottom: none; }
  .day-row::after {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 0; background: rgba(78,207,98,0.04);
    transition: width 0.4s;
  }
  .day-row.done::after { width: 100%; }

  .day-number {
    min-width: 30px; height: 30px; border-radius: 50%;
    background: var(--border); display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace; font-size: 0.62rem; font-weight: 700;
    color: var(--muted); flex-shrink: 0; transition: all 0.25s; position: relative; z-index: 1;
  }
  .day-row.today .day-number {
    background: var(--accent2); color: #fff;
    box-shadow: 0 0 12px rgba(78,207,98,0.4);
  }
  .day-row.done .day-number {
    background: rgba(78,207,98,0.18); color: var(--accent);
  }

  .day-info { flex: 1; min-width: 0; position: relative; z-index: 1; }
  .day-title {
    font-size: 0.79rem; font-weight: 600; color: var(--text); margin-bottom: 1px;
    display: flex; align-items: center; gap: 6px;
  }
  .day-row.done .day-title { text-decoration: line-through; opacity: 0.6; }
  .day-desc { font-size: 0.71rem; color: var(--muted); line-height: 1.4; }

  .day-tag {
    font-size: 0.59rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em;
    padding: 2px 7px; border-radius: 4px; flex-shrink: 0; position: relative; z-index: 1;
  }
  .day-tag.spray { background: rgba(78,207,98,0.12); color: var(--accent); }
  .day-tag.observe { background: rgba(232,197,71,0.12); color: var(--warn); }
  .day-tag.rest { background: rgba(126,200,227,0.12); color: #7ec8e3; }
  .day-tag.treat { background: rgba(232,96,96,0.12); color: var(--danger); }
  .day-tag.water { background: rgba(100,160,255,0.12); color: #82b8ff; }

  .day-check {
    width: 18px; height: 18px; border-radius: 50%;
    border: 1.5px solid var(--border); flex-shrink: 0;
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.6rem; position: relative; z-index: 1;
  }
  .day-check:hover { border-color: var(--accent); }
  .day-row.done .day-check {
    background: var(--accent2); border-color: var(--accent2); color: #fff;
  }

  .routine-footer {
    padding: 10px 14px; display: flex; align-items: center; justify-content: space-between;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,0.06);
  }
  body.light .routine-footer { background: rgba(0,0,0,0.02); }
  .routine-progress-wrap { flex: 1; margin-right: 12px; }
  .routine-progress-label {
    font-size: 0.67rem; color: var(--muted); margin-bottom: 5px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .routine-progress-label span:last-child { color: var(--accent); font-weight: 600; }
  .routine-progress-track { height: 5px; background: var(--border); border-radius: 5px; overflow: hidden; }
  .routine-progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 5px; transition: width 0.45s cubic-bezier(0.4,0,0.2,1);
  }
  .routine-reset-btn {
    font-size: 0.67rem; color: var(--muted); cursor: pointer; padding: 4px 10px;
    border-radius: 6px; border: 1px solid var(--border); background: transparent;
    font-family: 'DM Sans', sans-serif; transition: all 0.2s; flex-shrink: 0;
  }
  .routine-reset-btn:hover { color: var(--danger); border-color: rgba(232,96,96,0.5); }

  /* Today badge */
  .today-badge {
    font-size: 0.58rem; background: var(--accent2); color: #fff;
    padding: 1px 5px; border-radius: 3px; font-weight: 700; letter-spacing: 0.04em;
  }

  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE â€” TABLET (â‰¤900px)
     Panels overlay on top of chat
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media (max-width: 900px) {
    .logo span { display: none; }
    .toggle-label { display: none; }
    .status-dot + span { display: none; }

    .panel {
      position: absolute;
      top: 0; bottom: 0;
      width: 0 !important;
      z-index: 50;
      box-shadow: none;
      transition: width 0.32s cubic-bezier(0.4,0,0.2,1), box-shadow 0.32s;
    }
    .panel.left { left: 0; }
    .panel.right { right: 0; }
    .panel.open {
      width: 300px !important;
      box-shadow: 4px 0 24px rgba(0,0,0,0.4);
    }
    .panel.right.open {
      box-shadow: -4px 0 24px rgba(0,0,0,0.4);
    }

    .panel-backdrop {
      display: none;
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 45;
    }
    .panel-backdrop.show { display: block; }

    .msg-bubble { max-width: 85%; }
    .chat-messages { padding: 16px; }
    .chat-header { padding: 12px 16px; }
    .chat-subtitle { display: none; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE â€” MOBILE (â‰¤600px)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media (max-width: 600px) {
    body { height: 100dvh; }
    nav { padding: 0 12px; height: 52px; }
    .logo { font-size: 1.1rem; gap: 8px; }
    .logo-icon { width: 30px; height: 30px; font-size: 1rem; }
    .nav-btn.outline:not(.icon-only) { display: none; }
    .nav-btn.primary { display: none; }
    .app-body { padding-bottom: 60px; }
    .panel.open { width: 100vw !important; }
    .panel-inner { width: 100vw; }
    .bottom-nav {
      display: flex !important;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 60px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      z-index: 200;
      align-items: stretch;
    }
    .bottom-nav-btn {
      flex: 1;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 3px;
      background: none; border: none;
      color: var(--muted); cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.6rem; font-weight: 500;
      padding: 6px 4px;
      transition: color 0.2s;
      border-top: 2px solid transparent;
    }
    .bottom-nav-btn .bnav-icon { font-size: 1.3rem; line-height: 1; }
    .bottom-nav-btn:hover,
    .bottom-nav-btn.active { color: var(--accent); border-top-color: var(--accent); }
    .chat-messages { padding: 12px; gap: 12px; }
    .chat-header { padding: 10px 12px; gap: 10px; }
    .ai-avatar { width: 34px; height: 34px; font-size: 0.95rem; }
    .chat-title { font-size: 0.9rem; }
    .chat-subtitle { display: none; }
    .chat-header > div:last-child { display: none; }
    .chat-input-area { padding: 10px 12px; }
    .upload-btn-big { padding: 10px 18px; font-size: 0.82rem; }
    .msg-bubble { max-width: 88%; font-size: 0.84rem; padding: 10px 13px; }
    .msg-actions { padding-left: 36px; }
    .upload-preview { flex-wrap: wrap; }
    .preview-info { min-width: 0; }
    .preview-name { font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
  }

  .bottom-nav { display: none; }

  @media (min-width: 1280px) {
    .panel.open { width: 340px; }
    .panel-inner { width: 340px; }
    .msg-bubble { max-width: 68%; }
    nav { padding: 0 28px; }
  }

  @media (min-width: 1600px) {
    .panel.open { width: 380px; }
    .panel-inner { width: 380px; }
  }

  /* â”€â”€ MODAL OVERLAY â”€â”€ */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 16px; width: 90%; max-width: 480px;
    max-height: 80vh; display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: modalIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes modalIn { from{opacity:0;transform:scale(0.92) translateY(10px)} to{opacity:1;transform:none} }

  .modal-header {
    padding: 18px 20px 14px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .modal-title { font-size: 0.95rem; font-weight: 600; display:flex; align-items:center; gap:8px; }
  .modal-close {
    width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .modal-close:hover { border-color: var(--danger); color: var(--danger); }
  .modal-body { flex: 1; overflow-y: auto; padding: 14px 16px; }
  .modal-body::-webkit-scrollbar { width: 3px; }
  .modal-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); display:flex; gap:8px; flex-shrink:0; }

  .history-empty { text-align:center; padding:40px 20px; color:var(--muted); font-size:0.85rem; }
  .history-empty .empty-icon { font-size:2.5rem; margin-bottom:10px; }
  .history-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
    position: relative;
  }
  .history-item:hover { border-color: var(--accent2); }
  .history-item-title { font-size: 0.83rem; font-weight: 600; margin-bottom: 4px; color: var(--text); }
  .history-item-meta { font-size: 0.72rem; color: var(--muted); display:flex; gap:10px; }
  .history-item-preview { font-size: 0.76rem; color: var(--muted); margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .history-item-actions { position:absolute; top:10px; right:10px; display:flex; gap:5px; }
  .hist-action-btn {
    padding: 3px 8px; border-radius: 6px; font-size: 0.68rem; cursor: pointer;
    border: 1px solid var(--border); background: transparent; font-family:'DM Sans',sans-serif;
  }
  .hist-action-btn.restore { color: var(--accent); border-color: rgba(78,207,98,0.3); }
  .hist-action-btn.restore:hover { background: rgba(78,207,98,0.1); }
  .hist-action-btn.del { color: var(--danger); border-color: rgba(232,96,96,0.3); }
  .hist-action-btn.del:hover { background: rgba(232,96,96,0.1); }
  .modal-action-btn {
    flex: 1; padding: 8px; border-radius: 8px; font-family:'DM Sans',sans-serif;
    font-size: 0.8rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border);
    background: transparent; color: var(--muted); transition: all 0.2s;
  }
  .modal-action-btn:hover { border-color: var(--accent2); color: var(--accent); }
  .modal-action-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
  .modal-action-btn.primary { background: var(--accent2); color: #fff; border-color: var(--accent2); }
  .modal-action-btn.primary:hover { background: var(--accent); border-color: var(--accent); }

  .lang-option {
    display: flex; align-items: center; gap: 14px; padding: 14px 16px;
    background: var(--card); border: 2px solid var(--border); border-radius: 12px;
    margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
  }
  .lang-option:hover { border-color: var(--accent2); }
  .lang-option.selected { border-color: var(--accent); background: rgba(78,207,98,0.07); }
  .lang-flag { font-size: 1.8rem; }
  .lang-name { font-size: 0.92rem; font-weight: 600; }
  .lang-native { font-size: 0.78rem; color: var(--muted); }
  .lang-check { margin-left: auto; font-size: 1.1rem; color: var(--accent); opacity: 0; transition: opacity 0.2s; }
  .lang-option.selected .lang-check { opacity: 1; }
  .translate-note { font-size: 0.75rem; color: var(--muted); text-align:center; margin-top:10px; line-height:1.5; }
  #langSearch:focus { border-color: var(--accent2); }
  #langList::-webkit-scrollbar { width: 3px; }
  #langList::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="nav-btn outline" id="newsNavBtn" onclick="togglePanel('left')" title="News & Alerts" style="padding:7px 10px;font-size:1rem;">ğŸ“°</button>
    <div class="logo">
      <div class="logo-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="10" y1="18" x2="10" y2="5" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M10 13.5C10 13.5 6.5 12.5 6.5 9.5C6.5 9.5 9.5 9.5 10 13.5Z" fill="white" opacity="0.95"/>
          <path d="M10 13.5C10 13.5 13.5 12.5 13.5 9.5C13.5 9.5 10.5 9.5 10 13.5Z" fill="white" opacity="0.95"/>
          <path d="M10 9.5C10 9.5 7.5 8.5 7.5 6C7.5 6 10 6 10 9.5Z" fill="white" opacity="0.7"/>
          <path d="M10 9.5C10 9.5 12.5 8.5 12.5 6C12.5 6 10 6 10 9.5Z" fill="white" opacity="0.7"/>
          <circle cx="10" cy="4.5" r="1.3" fill="white" opacity="0.6"/>
        </svg>
      </div>
      Fasal <span>/ Digital Doctor for Farmers</span>
    </div>
  </div>
  <div class="nav-right">
    <div class="status-dot"></div>
    <span style="font-size:0.78rem;color:var(--muted)">AI Online</span>
    <button class="nav-btn outline">ğŸŒ EN / à¤¹à¤¿à¤¨à¥à¤¦à¥€</button>
    <div class="theme-toggle-wrap" onclick="toggleTheme()" title="Toggle light/dark">
      <span class="t-icon" id="themeIcon">ğŸŒ™</span>
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
      <span class="toggle-label" id="themeLabel">Dark</span>
    </div>
    <button class="nav-btn primary">+ New Scan</button>
  </div>
</nav>

<!-- APP BODY -->
<div class="app-body">

  <div class="panel-backdrop" id="panelBackdrop" onclick="closeAllPanels()"></div>

  <!-- LEFT PANEL: NEWS & ALERTS -->
  <div class="panel left" id="panelLeft">
    <div class="panel-inner">
      <div class="sidebar-header">
        <span class="sidebar-title">ğŸ“° Crop News & Alerts</span>
        <span class="tag-pill active">Live</span>
      </div>
      <div class="slideshow-wrap">
        <div class="slides" id="slides"></div>
        <div class="slide-arrows">
          <div class="sarrow" onclick="prevSlide()">â€¹</div>
          <div class="sarrow" onclick="nextSlide()">â€º</div>
        </div>
      </div>
      <div class="slide-dots" id="slideDots"></div>
      <div class="news-filter">
        <span class="tag-pill active" onclick="filterNews(this,'all')">All</span>
        <span class="tag-pill inactive" onclick="filterNews(this,'disease')">Disease</span>
        <span class="tag-pill inactive" onclick="filterNews(this,'tip')">Tips</span>
        <span class="tag-pill inactive" onclick="filterNews(this,'market')">Market</span>
        <span class="tag-pill inactive" onclick="filterNews(this,'weather')">Weather</span>
      </div>
      <div class="news-feed" id="newsFeed"></div>
    </div>
  </div>

  <!-- CENTER: CHAT -->
  <div class="chat-area">
    <div class="chat-header">
      <div class="ai-avatar">ğŸ¤–</div>
      <div>
        <div class="chat-title">Fasal AI Assistant</div>
        <div class="chat-subtitle">Crop Disease Detection Â· Treatment Advice Â· Image Analysis</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="nav-btn outline" style="font-size:0.75rem;" onclick="openHistory()">ğŸ“‹ History</button>
        <button class="nav-btn outline" style="font-size:0.75rem;" id="translateBtn" onclick="openTranslate()">ğŸŒ Translate</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-area">
      <div class="upload-row">
        <div class="upload-preview" id="uploadPreview">
          <div class="preview-thumb" id="previewThumb">ğŸ–¼ï¸</div>
          <div class="preview-info">
            <div class="preview-name" id="previewName">crop_photo.jpg</div>
            <div class="preview-size">Ready for AI disease analysis</div>
          </div>
          <button class="preview-send" onclick="submitImage()">Analyze â¤</button>
          <div class="preview-remove" onclick="removeUpload()">âœ•</div>
        </div>
        <button class="upload-btn-big" id="imgBtn" onclick="document.getElementById('imageInput').click()">
          ğŸ“¸ Upload Crop Photo
        </button>
      </div>
    </div>
    <input type="file" id="imageInput" style="display:none" accept="image/*" onchange="handleImageUpload(this)">
  </div>

</div><!-- end app-body -->

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="historyModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ“‹ <span id="histModalTitle">Chat History</span></div>
      <button class="modal-close" onclick="closeModal('historyModal')">âœ•</button>
    </div>
    <div class="modal-body" id="historyBody"></div>
    <div class="modal-footer">
      <button class="modal-action-btn danger" onclick="clearAllHistory()" id="clearAllBtn">ğŸ—‘ Clear All</button>
      <button class="modal-action-btn primary" onclick="saveCurrentSession()">ğŸ’¾ Save Current</button>
    </div>
  </div>
</div>

<!-- TRANSLATE MODAL -->
<div class="modal-overlay" id="translateModal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-header">
      <div class="modal-title">ğŸŒ <span id="transModalTitle">Select Language</span></div>
      <button class="modal-close" onclick="closeModal('translateModal')">âœ•</button>
    </div>
    <div class="modal-body" style="padding:12px 14px 6px;">
      <input type="text" id="langSearch" placeholder="ğŸ” Search language..." oninput="filterLangs(this.value)"
        style="width:100%;padding:9px 13px;border-radius:9px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.85rem;outline:none;margin-bottom:10px;">
      <div id="langList" style="max-height:420px;overflow-y:auto;"></div>
      <div class="translate-note" id="translateNote">Switching language will translate the interface and chat messages.</div>
    </div>
    <div class="modal-footer">
      <button class="modal-action-btn" onclick="closeModal('translateModal')" id="transCloseBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<nav class="bottom-nav" id="bottomNav">
  <button class="bottom-nav-btn" id="bnavNews" onclick="togglePanelMobile('left')">
    <span class="bnav-icon">ğŸ“°</span>News
  </button>
  <button class="bottom-nav-btn" id="bnavChat" onclick="closePanelMobileGoChat()" style="color:var(--accent);border-top-color:var(--accent)">
    <span class="bnav-icon">ğŸ¤–</span>Chat
  </button>
</nav>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isMobileTablet() { return window.innerWidth <= 900; }

function togglePanel(side) {
  const panel = document.getElementById('panelLeft');
  const backdrop = document.getElementById('panelBackdrop');
  panel.classList.toggle('open');
  if (isMobileTablet()) {
    backdrop.classList.toggle('show', panel.classList.contains('open'));
  }
}

function togglePanelMobile(side) {
  const panel = document.getElementById('panelLeft');
  const isOpening = !panel.classList.contains('open');
  togglePanel(side);
  document.getElementById('bnavNews').classList.toggle('active', isOpening);
  document.getElementById('bnavChat').classList.toggle('active', false);
  if (!isOpening) document.getElementById('bnavChat').classList.add('active');
}

function closePanelMobileGoChat() {
  closeAllPanels();
  document.getElementById('bnavChat').classList.add('active');
  document.getElementById('bnavNews').classList.remove('active');
}

function closeAllPanels() {
  document.getElementById('panelLeft').classList.remove('open');
  document.getElementById('panelBackdrop').classList.remove('show');
  document.getElementById('bnavChat').classList.add('active');
  document.getElementById('bnavNews').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEWS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const newsItems = [
  { type:'disease', title:'Wheat Rust Alert: High Risk in Punjab Region This Season', time:'2h ago', crop:'Wheat', icon:'âš ï¸' },
  { type:'tip', title:'Top 5 Natural Ways to Prevent Powdery Mildew in Grapes', time:'4h ago', crop:'Grapes', icon:'ğŸ’¡' },
  { type:'market', title:'Onion prices surge 18% ahead of monsoon season â€” protect your yield', time:'5h ago', crop:'Onion', icon:'ğŸ“ˆ' },
  { type:'weather', title:'Heavy Rainfall Expected: Precautions for Paddy Farmers in Haryana', time:'6h ago', crop:'Paddy', icon:'ğŸŒ§ï¸' },
  { type:'disease', title:'New Strain of Tomato Leaf Curl Virus Detected in Maharashtra', time:'8h ago', crop:'Tomato', icon:'ğŸ”´' },
  { type:'tip', title:'How to Increase Mango Yield by 30% with Proper Pruning', time:'12h ago', crop:'Mango', icon:'ğŸ¥­' },
  { type:'market', title:'Soybean futures rise: Good time to sell your stockpile', time:'1d ago', crop:'Soybean', icon:'ğŸ“Š' },
  { type:'weather', title:'Frost Warning Issued: Protect your vegetable crops tonight', time:'1d ago', crop:'Vegetables', icon:'ğŸŒ¨ï¸' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLIDESHOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let slideIndex = 0;
const slideshowItems = newsItems.slice(0, 4);
let slideTimer;

function buildSlideshow() {
  const wrap = document.getElementById('slides');
  const dots = document.getElementById('slideDots');
  wrap.innerHTML = slideshowItems.map(n => `
    <div class="slide">
      <div class="slide-tag ${n.type}">${n.icon} ${n.type.toUpperCase()}</div>
      <div class="slide-title">${n.title}</div>
      <div class="slide-meta"><span>ğŸŒ¾ ${n.crop}</span><span>${n.time}</span></div>
    </div>`).join('');
  dots.innerHTML = slideshowItems.map((_,i) => `<div class="sdot ${i===0?'active':''}" onclick="goSlide(${i})"></div>`).join('');
}

function goSlide(i) {
  slideIndex = i;
  document.getElementById('slides').style.transform = `translateX(-${i * 100}%)`;
  document.querySelectorAll('.sdot').forEach((d,j) => d.classList.toggle('active', j===i));
  clearInterval(slideTimer);
  slideTimer = setInterval(nextSlide, 4000);
}
function nextSlide() { goSlide((slideIndex + 1) % slideshowItems.length); }
function prevSlide() { goSlide((slideIndex - 1 + slideshowItems.length) % slideshowItems.length); }

buildSlideshow();
slideTimer = setInterval(nextSlide, 4000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEWS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNewsCards(items) {
  document.getElementById('newsFeed').innerHTML = items.map(n => `
    <div class="news-card ${n.type==='disease'?'alert':n.type==='weather'?'warn':''}">
      <div class="news-tag ${n.type}">${n.icon} ${n.type.toUpperCase()}</div>
      <div class="news-title">${n.title}</div>
      <div class="news-meta"><span>ğŸŒ¾ ${n.crop}</span><span>${n.time}</span></div>
    </div>`).join('');
}
renderNewsCards(newsItems);

function filterNews(el, type) {
  document.querySelectorAll('.news-filter .tag-pill').forEach(p => p.className = 'tag-pill inactive');
  el.className = 'tag-pill active';
  renderNewsCards(type === 'all' ? newsItems : newsItems.filter(n => n.type === type));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7-DAY CARE ROUTINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROUTINE_STORAGE_KEY = 'fasal_routine_state';

// Routine data â€” both languages
const routineData = {
  en: [
    { day:1, title:'First Fungicide Spray',            desc:'Prepare Mancozeb 75% WP at 2g per litre of water. Spray evenly on all affected leaves, front and back. Early morning is best.',                                              tag:'spray',   emoji:'ğŸ’Š', tagLabel:'spray'   },
    { day:2, title:'Inspect & Remove Infected Leaves', desc:'Carefully remove heavily spotted or yellowing leaves. Bag and dispose away from field. Do not compost infected material.',                                                    tag:'treat',   emoji:'ğŸƒ', tagLabel:'treat'   },
    { day:3, title:'Rest & Monitor Humidity',          desc:'Let the fungicide settle. Avoid overhead irrigation today. Check soil moisture and ensure good drainage around plants.',                                                       tag:'rest',    emoji:'ğŸŒ¤ï¸', tagLabel:'rest'    },
    { day:4, title:'Second Fungicide Spray',           desc:'Repeat Mancozeb spray at 2g/L. Check for new spots. If worsening, add Carbendazim 50% WP at 1g/L to the mix.',                                                              tag:'spray',   emoji:'ğŸ’Š', tagLabel:'spray'   },
    { day:5, title:'Foliar Nutrition Boost',           desc:'Apply potassium-rich foliar spray (0.5% Kâ‚‚SOâ‚„) to strengthen cell walls and boost immunity against fungal spread.',                                                          tag:'observe', emoji:'ğŸŒ¿', tagLabel:'observe' },
    { day:6, title:'Deep Field Observation',           desc:'Walk the full field. Note any new infection clusters. Check neighbouring crops. Record progress vs Day 1 for comparison.',                                                    tag:'observe', emoji:'ğŸ”', tagLabel:'observe' },
    { day:7, title:'Final Spray & Review',             desc:'Apply third and final fungicide spray. Assess overall improvement. If >50% recovery seen, treatment is successful.',                                                          tag:'spray',   emoji:'âœ…', tagLabel:'spray'   },
  ],
  hi: [
    { day:1, title:'à¤ªà¤¹à¤²à¤¾ à¤«à¤«à¥‚à¤‚à¤¦à¤¨à¤¾à¤¶à¤• à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ',           desc:'à¤®à¥ˆà¤¨à¤•à¥‹à¤œà¥‡à¤¬ 75% WP à¤•à¥‹ 2 à¤—à¥à¤°à¤¾à¤® à¤ªà¥à¤°à¤¤à¤¿ à¤²à¥€à¤Ÿà¤° à¤ªà¤¾à¤¨à¥€ à¤®à¥‡à¤‚ à¤¤à¥ˆà¤¯à¤¾à¤° à¤•à¤°à¥‡à¤‚à¥¤ à¤ªà¥à¤°à¤­à¤¾à¤µà¤¿à¤¤ à¤¸à¤­à¥€ à¤ªà¤¤à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤ªà¤° à¤†à¤—à¥‡ à¤”à¤° à¤ªà¥€à¤›à¥‡ à¤¸à¥‡ à¤¸à¤®à¤¾à¤¨ à¤°à¥‚à¤ª à¤¸à¥‡ à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ à¤•à¤°à¥‡à¤‚à¥¤ à¤¸à¥à¤¬à¤¹ à¤œà¤²à¥à¤¦à¥€ à¤•à¤°à¤¨à¤¾ à¤¸à¤¬à¤¸à¥‡ à¤…à¤šà¥à¤›à¤¾ à¤¹à¥ˆà¥¤',        tag:'spray',   emoji:'ğŸ’Š', tagLabel:'à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ'  },
    { day:2, title:'à¤¸à¤‚à¤•à¥à¤°à¤®à¤¿à¤¤ à¤ªà¤¤à¥à¤¤à¤¿à¤¯à¤¾à¤ à¤¹à¤Ÿà¤¾à¤à¤‚',           desc:'à¤…à¤§à¤¿à¤• à¤§à¤¬à¥à¤¬à¥‡à¤¦à¤¾à¤° à¤¯à¤¾ à¤ªà¥€à¤²à¥€ à¤ªà¤¡à¤¼ à¤°à¤¹à¥€ à¤ªà¤¤à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤•à¥‹ à¤¸à¤¾à¤µà¤§à¤¾à¤¨à¥€ à¤¸à¥‡ à¤¹à¤Ÿà¤¾à¤à¤‚à¥¤ à¤‰à¤¨à¥à¤¹à¥‡à¤‚ à¤¥à¥ˆà¤²à¥‡ à¤®à¥‡à¤‚ à¤¬à¤‚à¤¦ à¤•à¤°à¤•à¥‡ à¤–à¥‡à¤¤ à¤¸à¥‡ à¤¦à¥‚à¤° à¤«à¥‡à¤‚à¤•à¥‡à¤‚à¥¤ à¤¸à¤‚à¤•à¥à¤°à¤®à¤¿à¤¤ à¤¸à¤¾à¤®à¤—à¥à¤°à¥€ à¤•à¥‹ à¤–à¤¾à¤¦ à¤®à¥‡à¤‚ à¤¨ à¤¡à¤¾à¤²à¥‡à¤‚à¥¤',                   tag:'treat',   emoji:'ğŸƒ', tagLabel:'à¤‰à¤ªà¤šà¤¾à¤°'    },
    { day:3, title:'à¤†à¤°à¤¾à¤® à¤”à¤° à¤¨à¤®à¥€ à¤•à¥€ à¤¨à¤¿à¤—à¤°à¤¾à¤¨à¥€',            desc:'à¤«à¤«à¥‚à¤‚à¤¦à¤¨à¤¾à¤¶à¤• à¤•à¥‹ à¤…à¤¸à¤° à¤•à¤°à¤¨à¥‡ à¤¦à¥‡à¤‚à¥¤ à¤†à¤œ à¤Šà¤ªà¤° à¤¸à¥‡ à¤¸à¤¿à¤‚à¤šà¤¾à¤ˆ à¤¨ à¤•à¤°à¥‡à¤‚à¥¤ à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¥€ à¤¨à¤®à¥€ à¤œà¤¾à¤‚à¤šà¥‡à¤‚ à¤”à¤° à¤ªà¥Œà¤§à¥‹à¤‚ à¤•à¥‡ à¤†à¤¸à¤ªà¤¾à¤¸ à¤œà¤² à¤¨à¤¿à¤•à¤¾à¤¸à¥€ à¤¸à¥à¤¨à¤¿à¤¶à¥à¤šà¤¿à¤¤ à¤•à¤°à¥‡à¤‚à¥¤',                                           tag:'rest',    emoji:'ğŸŒ¤ï¸', tagLabel:'à¤†à¤°à¤¾à¤®'     },
    { day:4, title:'à¤¦à¥‚à¤¸à¤°à¤¾ à¤«à¤«à¥‚à¤‚à¤¦à¤¨à¤¾à¤¶à¤• à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ',          desc:'à¤®à¥ˆà¤¨à¤•à¥‹à¤œà¥‡à¤¬ à¤•à¤¾ 2g/L à¤ªà¤° à¤¦à¥‹à¤¬à¤¾à¤°à¤¾ à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ à¤•à¤°à¥‡à¤‚à¥¤ à¤¨à¤ à¤§à¤¬à¥à¤¬à¥‡ à¤œà¤¾à¤‚à¤šà¥‡à¤‚à¥¤ à¤¯à¤¦à¤¿ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤¬à¤¿à¤—à¤¡à¤¼ à¤°à¤¹à¥€ à¤¹à¥‹, à¤¤à¥‹ à¤•à¤¾à¤°à¥à¤¬à¥‡à¤¨à¥à¤¡à¤¾à¤œà¤¿à¤® 50% WP à¤•à¥‹ 1g/L à¤•à¥€ à¤¦à¤° à¤¸à¥‡ à¤®à¤¿à¤²à¤¾à¤à¤‚à¥¤',                          tag:'spray',   emoji:'ğŸ’Š', tagLabel:'à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ'  },
    { day:5, title:'à¤ªà¤¤à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤ªà¤° à¤ªà¥‹à¤·à¤£ à¤¬à¥‚à¤¸à¥à¤Ÿ',            desc:'à¤ªà¥‹à¤Ÿà¥‡à¤¶à¤¿à¤¯à¤® à¤¯à¥à¤•à¥à¤¤ à¤ªà¤°à¥à¤£à¥€à¤¯ à¤¸à¥à¤ªà¥à¤°à¥‡ (0.5% Kâ‚‚SOâ‚„) à¤²à¤—à¤¾à¤à¤‚à¥¤ à¤‡à¤¸à¤¸à¥‡ à¤•à¥‹à¤¶à¤¿à¤•à¤¾ à¤­à¤¿à¤¤à¥à¤¤à¤¿ à¤®à¤œà¤¬à¥‚à¤¤ à¤¹à¥‹à¤—à¥€ à¤”à¤° à¤«à¤«à¥‚à¤‚à¤¦à¥€ à¤«à¥ˆà¤²à¤¨à¥‡ à¤¸à¥‡ à¤°à¥‹à¤—-à¤ªà¥à¤°à¤¤à¤¿à¤°à¥‹à¤§à¤• à¤•à¥à¤·à¤®à¤¤à¤¾ à¤¬à¤¢à¤¼à¥‡à¤—à¥€à¥¤',                              tag:'observe', emoji:'ğŸŒ¿', tagLabel:'à¤¨à¤¿à¤°à¥€à¤•à¥à¤·à¤£' },
    { day:6, title:'à¤–à¥‡à¤¤ à¤•à¤¾ à¤—à¤¹à¤¨ à¤¨à¤¿à¤°à¥€à¤•à¥à¤·à¤£',               desc:'à¤ªà¥‚à¤°à¥‡ à¤–à¥‡à¤¤ à¤®à¥‡à¤‚ à¤šà¤²à¥‡à¤‚à¥¤ à¤¨à¤ à¤¸à¤‚à¤•à¥à¤°à¤®à¤£ à¤•à¥‡ à¤¸à¤®à¥‚à¤¹à¥‹à¤‚ à¤•à¥‹ à¤¨à¥‹à¤Ÿ à¤•à¤°à¥‡à¤‚à¥¤ à¤ªà¤¡à¤¼à¥‹à¤¸à¥€ à¤«à¤¸à¤²à¥‹à¤‚ à¤•à¥€ à¤œà¤¾à¤‚à¤š à¤•à¤°à¥‡à¤‚à¥¤ à¤ªà¤¹à¤²à¥‡ à¤¦à¤¿à¤¨ à¤•à¥€ à¤¤à¥à¤²à¤¨à¤¾ à¤®à¥‡à¤‚ à¤ªà¥à¤°à¤—à¤¤à¤¿ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤',                                       tag:'observe', emoji:'ğŸ”', tagLabel:'à¤¨à¤¿à¤°à¥€à¤•à¥à¤·à¤£' },
    { day:7, title:'à¤…à¤‚à¤¤à¤¿à¤® à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ à¤”à¤° à¤¸à¤®à¥€à¤•à¥à¤·à¤¾',          desc:'à¤¤à¥€à¤¸à¤°à¤¾ à¤”à¤° à¤…à¤‚à¤¤à¤¿à¤® à¤«à¤«à¥‚à¤‚à¤¦à¤¨à¤¾à¤¶à¤• à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ à¤•à¤°à¥‡à¤‚à¥¤ à¤•à¥à¤² à¤¸à¥à¤§à¤¾à¤° à¤•à¤¾ à¤®à¥‚à¤²à¥à¤¯à¤¾à¤‚à¤•à¤¨ à¤•à¤°à¥‡à¤‚à¥¤ à¤¯à¤¦à¤¿ 50% à¤¸à¥‡ à¤…à¤§à¤¿à¤• à¤¸à¥à¤§à¤¾à¤° à¤¦à¤¿à¤–à¥‡, à¤¤à¥‹ à¤‰à¤ªà¤šà¤¾à¤° à¤¸à¤«à¤² à¤®à¤¾à¤¨à¤¾ à¤œà¤¾à¤à¤—à¤¾à¥¤',                                   tag:'spray',   emoji:'âœ…', tagLabel:'à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ'  },
  ]
};

// Default routine (English, used for building initial card)
const defaultRoutine = routineData.en;

let routineState = { done: [], cardId: null };

function loadRoutineState(cardId) {
  try {
    const saved = JSON.parse(localStorage.getItem(ROUTINE_STORAGE_KEY) || '{}');
    if (saved.cardId === cardId) return saved;
  } catch(e) {}
  return { done: [], cardId };
}

function saveRoutineState(cardId, done) {
  try {
    localStorage.setItem(ROUTINE_STORAGE_KEY, JSON.stringify({ cardId, done }));
  } catch(e) {}
}

// Track all rendered routine card IDs so we can re-translate them
const activeRoutineCardIds = [];

function buildRoutineCard(diagnosisName, lang) {
  const cardId = 'routine_' + Date.now();
  routineState = loadRoutineState(cardId);
  activeRoutineCardIds.push(cardId);

  const days = routineData[lang] || routineData.en;
  const t = chatTranslations[lang] || chatTranslations.en;
  const isHi = lang === 'hi';

  const daysHTML = days.map((d, i) => {
    const isDone = routineState.done.includes(d.day);
    const isToday = !isDone && routineState.done.length === i;
    const todayWord = isHi ? 'à¤†à¤œ' : 'TODAY';
    return `
      <div class="day-row ${isDone ? 'done' : ''} ${isToday ? 'today' : ''}" id="${cardId}_day${d.day}" onclick="toggleDay('${cardId}', ${d.day})">
        <div class="day-number">${isHi ? 'à¤¦à¤¿' : 'D'}${d.day}</div>
        <div class="day-info">
          <div class="day-title">
            ${d.emoji} ${d.title}
            ${isToday ? `<span class="today-badge">${todayWord}</span>` : ''}
          </div>
          <div class="day-desc">${d.desc}</div>
        </div>
        <span class="day-tag ${d.tag}">${d.tagLabel}</span>
        <div class="day-check">${isDone ? 'âœ“' : ''}</div>
      </div>`;
  }).join('');

  const doneCount = routineState.done.length;
  const pct = Math.round((doneCount / days.length) * 100);
  const progressLabel = isHi ? 'à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤²à¤¾à¤­ à¤ªà¥à¤°à¤—à¤¤à¤¿' : 'Recovery Progress';
  const daysWord = isHi ? 'à¤¦à¤¿à¤¨' : 'days';
  const resetLabel = isHi ? 'â†º à¤°à¥€à¤¸à¥‡à¤Ÿ' : 'â†º Reset';

  return `
    <div class="routine-card" id="${cardId}" data-lang="${lang}">
      <div class="routine-header" onclick="toggleRoutineBody('${cardId}')">
        <div class="routine-header-left">
          <div class="routine-icon-wrap">ğŸŒ±</div>
          <div>
            <div class="routine-title">${t.routineTitle}</div>
            <div class="routine-subtitle">${isHi ? `${t.diagnosisName} à¤•à¥‡ à¤²à¤¿à¤` : `Tailored for ${diagnosisName}`}</div>
          </div>
        </div>
        <div class="routine-chevron open" id="${cardId}_chevron">â–¼</div>
      </div>
      <div class="routine-body open" id="${cardId}_body">
        <div class="day-grid" id="${cardId}_grid">${daysHTML}</div>
        <div class="routine-footer">
          <div class="routine-progress-wrap">
            <div class="routine-progress-label">
              <span id="${cardId}_progressLabel">${progressLabel}</span>
              <span id="${cardId}_pctLabel">${doneCount}/${days.length} ${daysWord} Â· ${pct}%</span>
            </div>
            <div class="routine-progress-track">
              <div class="routine-progress-fill" id="${cardId}_fill" style="width:${pct}%"></div>
            </div>
          </div>
          <button class="routine-reset-btn" id="${cardId}_resetBtn" onclick="resetRoutine(event,'${cardId}')">${resetLabel}</button>
        </div>
      </div>
    </div>`;
}

function toggleRoutineBody(cardId) {
  const body = document.getElementById(cardId + '_body');
  const chevron = document.getElementById(cardId + '_chevron');
  body.classList.toggle('open');
  chevron.classList.toggle('open');
}

function toggleDay(cardId, dayNum) {
  const state = loadRoutineState(cardId);
  const idx = state.done.indexOf(dayNum);
  if (idx > -1) {
    state.done.splice(idx, 1);
  } else {
    state.done.push(dayNum);
    state.done.sort((a, b) => a - b);
  }
  saveRoutineState(cardId, state.done);
  refreshRoutineUI(cardId, state.done);
}

function refreshRoutineUI(cardId, done) {
  const card = document.getElementById(cardId);
  const lang = card ? (card.dataset.lang || 'en') : 'en';
  const days = routineData[lang] || routineData.en;
  const isHi = lang === 'hi';
  const todayWord = isHi ? 'à¤†à¤œ' : 'TODAY';

  days.forEach((d, i) => {
    const row = document.getElementById(`${cardId}_day${d.day}`);
    if (!row) return;
    const isDone = done.includes(d.day);
    const isToday = !isDone && done.length === i;
    row.className = `day-row ${isDone ? 'done' : ''} ${isToday ? 'today' : ''}`;
    const check = row.querySelector('.day-check');
    if (check) check.textContent = isDone ? 'âœ“' : '';
    const titleEl = row.querySelector('.day-title');
    if (titleEl) {
      const existingBadge = titleEl.querySelector('.today-badge');
      if (existingBadge) existingBadge.remove();
      if (isToday) {
        const badge = document.createElement('span');
        badge.className = 'today-badge';
        badge.textContent = todayWord;
        titleEl.appendChild(badge);
      }
    }
  });
  const pct = Math.round((done.length / days.length) * 100);
  const daysWord = isHi ? 'à¤¦à¤¿à¤¨' : 'days';
  const fill = document.getElementById(cardId + '_fill');
  const label = document.getElementById(cardId + '_pctLabel');
  if (fill) fill.style.width = pct + '%';
  if (label) label.textContent = `${done.length}/${days.length} ${daysWord} Â· ${pct}%`;
}

function resetRoutine(event, cardId) {
  event.stopPropagation();
  if (!confirm('Reset all progress for this routine?')) return;
  saveRoutineState(cardId, []);
  refreshRoutineUI(cardId, []);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hasImage = false, imageDataURL = null, aiMsgCounter = 0, currentSpeech = null, speakingBtn = null;

const responses = {
  image: {
    text: "I've scanned your uploaded image using AI disease detection. Here's my diagnosis:",
    diagnosis: { name: 'Alternaria Leaf Blight', confidence: 78, desc: 'Brown concentric ring spots on leaves. Common in onion, carrot. Recommend Mancozeb 75% WP at 2g/L water, apply weekly for 3 weeks.' }
  }
};

function speakMessage(btn, bubbleId) {
  if (btn === speakingBtn) { stopSpeech(); return; }
  stopSpeech();
  const bubble = document.getElementById(bubbleId);
  if (!bubble || !('speechSynthesis' in window)) return;
  const text = bubble.innerText || bubble.textContent;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-IN'; utter.rate = 0.92; utter.pitch = 1.05;
  const voices = speechSynthesis.getVoices();
  const v = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female')) || voices.find(v => v.lang.startsWith('en')) || voices[0];
  if (v) utter.voice = v;
  utter.onstart = () => { btn.classList.add('speaking'); btn.innerHTML = '<span class="speaker-icon">ğŸ”ˆ</span> Stop'; speakingBtn = btn; currentSpeech = utter; };
  utter.onend = utter.onerror = () => { resetSpeakBtn(btn); speakingBtn = null; currentSpeech = null; };
  speechSynthesis.speak(utter);
}
function stopSpeech() { if (currentSpeech) speechSynthesis.cancel(); if (speakingBtn) resetSpeakBtn(speakingBtn); speakingBtn = null; currentSpeech = null; }
function resetSpeakBtn(btn) { btn.classList.remove('speaking'); btn.innerHTML = '<span class="speaker-icon">ğŸ”Š</span> Read Aloud'; }

function appendAIMessage(content) {
  const msgs = document.getElementById('chatMessages');
  const bubbleId = 'aibubble_' + (aiMsgCounter++);
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `
    <div class="msg ai"><div class="msg-avatar ai-av">ğŸ¤–</div><div class="msg-bubble" id="${bubbleId}">${content}</div></div>
    <div class="msg-actions"><button class="read-aloud-btn" onclick="speakMessage(this,'${bubbleId}')"><span class="speaker-icon">ğŸ”Š</span> Read Aloud</button></div>`;
  msgs.appendChild(wrapper);
  msgs.scrollTop = msgs.scrollHeight;
  return bubbleId;
}

function appendDiagnosis(diagnosis, bubbleId) {
  const bubble = document.getElementById(bubbleId);
  if (bubble && diagnosis) {
    const card = document.createElement('div');
    card.className = 'diagnosis-card';
    card.innerHTML = `
      <div class="diagnosis-tag">ğŸ”¬ AI Diagnosis</div>
      <div class="diagnosis-name">${diagnosis.name}</div>
      <div class="diagnosis-detail">${diagnosis.desc}</div>
      <div class="confidence-bar">
        <span class="conf-label">Confidence</span>
        <div class="conf-track"><div class="conf-fill" style="width:${diagnosis.confidence}%"></div></div>
        <span class="conf-label">${diagnosis.confidence}%</span>
      </div>`;
    bubble.appendChild(card);

    // â”€â”€ APPEND 7-DAY ROUTINE CARD â”€â”€
    const routineHTML = buildRoutineCard(diagnosis.name, currentLang);
    const routineEl = document.createElement('div');
    routineEl.innerHTML = routineHTML;
    bubble.appendChild(routineEl.firstElementChild);

    document.getElementById('chatMessages').scrollTop = 99999;
  }
}

function showTyping() {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ai'; div.id = 'typingMsg';
  div.innerHTML = `<div class="msg-avatar ai-av">ğŸ¤–</div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
}
function removeTyping() { const t = document.getElementById('typingMsg'); if (t) t.remove(); }

function appendUserMessage(imgSrc) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div'); div.className = 'msg user';
  div.innerHTML = `<div class="msg-avatar user-av">ğŸ‘¨â€ğŸŒ¾</div><div class="msg-bubble"><div class="msg-image-preview" style="display:flex;overflow:hidden;">${imgSrc ? `<img src="${imgSrc}" style="width:100%;height:100%;object-fit:cover;border-radius:9px;" alt="crop">` : 'ğŸŒ¿'}</div>Please analyze this crop image for diseases.</div>`;
  msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
}

function submitImage() {
  if (!hasImage) return;
  stopSpeech(); appendUserMessage(imageDataURL); removeUpload(); showTyping();
  setTimeout(() => {
    removeTyping();
    const resp = responses.image;
    const id = appendAIMessage(resp.text);
    if (resp.diagnosis) setTimeout(() => appendDiagnosis(resp.diagnosis, id), 200);
  }, 1600);
}

function handleImageUpload(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0]; hasImage = true;
  const reader = new FileReader();
  reader.onload = e => { imageDataURL = e.target.result; document.getElementById('previewThumb').innerHTML = `<img src="${imageDataURL}" alt="preview">`; };
  reader.readAsDataURL(file);
  document.getElementById('previewName').textContent = file.name;
  document.getElementById('uploadPreview').classList.add('show');
  document.getElementById('imgBtn').classList.add('active');
}

function removeUpload() {
  document.getElementById('uploadPreview').classList.remove('show');
  document.getElementById('imageInput').value = '';
  document.getElementById('previewThumb').innerHTML = 'ğŸ–¼ï¸';
  hasImage = false; imageDataURL = null;
  document.getElementById('imgBtn').classList.remove('active');
}

// Welcome
(function() {
  appendAIMessage(`ğŸŒ± <strong>Namaste, Farmer!</strong> I'm Fasal AI, your digital crop doctor.<br><br>
    ğŸ“¸ <strong>Disease Detection</strong> â€” Upload a photo of your crop<br>
    ğŸ’Š <strong>Treatment Plans</strong> â€” Get medicine &amp; pesticide advice<br>
    ğŸŒ¦ï¸ <strong>Weather &amp; Seasonal Tips</strong><br><br>
    Tap ğŸ“° for crop news &amp; alerts, or upload a photo below!`);
})();

// Theme
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  document.getElementById('themeIcon').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('themeLabel').textContent = isLight ? 'Light' : 'Dark';
}

if ('speechSynthesis' in window) speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('show'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HISTORY_KEY = 'fasal_chat_history';

function getSessions() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch { return []; }
}
function saveSessions(sessions) {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(sessions));
}

function saveCurrentSession() {
  const msgs = document.getElementById('chatMessages');
  const allBubbles = msgs.querySelectorAll('.msg-bubble');
  if (allBubbles.length === 0) return;
  const preview = allBubbles[allBubbles.length - 1].innerText.slice(0, 80);
  const session = {
    id: Date.now(),
    date: new Date().toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }),
    msgCount: allBubbles.length,
    preview: preview,
    html: msgs.innerHTML
  };
  const sessions = getSessions();
  sessions.unshift(session);
  saveSessions(sessions.slice(0, 20));
  renderHistoryBody();
  const btn = document.querySelector('#historyModal .modal-action-btn.primary');
  if (btn) { const orig = btn.textContent; btn.textContent = 'âœ“ Saved!'; setTimeout(() => btn.textContent = orig, 1500); }
}

function renderHistoryBody() {
  const sessions = getSessions();
  const body = document.getElementById('historyBody');
  const isHindi = currentLang === 'hi';
  if (sessions.length === 0) {
    body.innerHTML = `<div class="history-empty"><div class="empty-icon">ğŸ“­</div><div>${isHindi ? 'à¤•à¥‹à¤ˆ à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¨à¤¹à¥€à¤‚' : 'No saved history yet'}</div><div style="font-size:0.72rem;margin-top:6px;color:var(--muted2)">${isHindi ? 'à¤¨à¥€à¤šà¥‡ "à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤¸à¤¹à¥‡à¤œà¥‡à¤‚" à¤ªà¤° à¤Ÿà¥ˆà¤ª à¤•à¤°à¥‡à¤‚' : 'Tap "Save Current" below to save this session'}</div></div>`;
    return;
  }
  body.innerHTML = sessions.map(s => `
    <div class="history-item">
      <div class="history-item-actions">
        <button class="hist-action-btn restore" onclick="restoreSession(${s.id})">${isHindi ? 'à¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚' : 'Load'}</button>
        <button class="hist-action-btn del" onclick="deleteSession(${s.id})">âœ•</button>
      </div>
      <div class="history-item-title">ğŸ’¬ ${isHindi ? 'à¤¸à¤¤à¥à¤°' : 'Session'} â€” ${s.date}</div>
      <div class="history-item-meta"><span>ğŸ—¨ ${s.msgCount} ${isHindi ? 'à¤¸à¤‚à¤¦à¥‡à¤¶' : 'messages'}</span></div>
      <div class="history-item-preview">${s.preview}â€¦</div>
    </div>`).join('');
}

function restoreSession(id) {
  const sessions = getSessions();
  const s = sessions.find(x => x.id === id);
  if (!s) return;
  if (!confirm(currentLang === 'hi' ? 'à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤šà¥ˆà¤Ÿ à¤•à¥€ à¤œà¤—à¤¹ à¤¯à¤¹ à¤¸à¤¤à¥à¤° à¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚?' : 'Load this session? Current chat will be replaced.')) return;
  document.getElementById('chatMessages').innerHTML = s.html;
  closeModal('historyModal');
}

function deleteSession(id) {
  const sessions = getSessions().filter(s => s.id !== id);
  saveSessions(sessions);
  renderHistoryBody();
}

function clearAllHistory() {
  if (!confirm(currentLang === 'hi' ? 'à¤¸à¤­à¥€ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¹à¤Ÿà¤¾à¤à¤‚?' : 'Delete all chat history?')) return;
  localStorage.removeItem(HISTORY_KEY);
  renderHistoryBody();
}

function openHistory() {
  renderHistoryBody();
  document.getElementById('histModalTitle').textContent = currentLang === 'hi' ? 'à¤šà¥ˆà¤Ÿ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸' : 'Chat History';
  document.getElementById('clearAllBtn').textContent = currentLang === 'hi' ? 'ğŸ—‘ à¤¸à¤­à¥€ à¤¹à¤Ÿà¤¾à¤à¤‚' : 'ğŸ—‘ Clear All';
  openModal('historyModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSLATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentLang = 'en';

const uiStrings = {
  en: {
    aiOnline: 'AI Online', langBtn: 'ğŸŒ EN / à¤¹à¤¿à¤¨à¥à¤¦à¥€', chatTitle: 'Fasal AI Assistant',
    chatSubtitle: 'Crop Disease Detection Â· Treatment Advice Â· Image Analysis',
    histBtn: 'ğŸ“‹ History', transBtn: 'ğŸŒ Translate', uploadBtn: 'ğŸ“¸ Upload Crop Photo',
    analyzeBtn: 'Analyze â¤', previewSize: 'Ready for AI disease analysis', newScan: '+ New Scan',
    transModalTitle: 'Select Language', translateNote: 'Switching language will translate the interface and all chat messages.',
    transClose: 'Cancel', newsTitle: 'ğŸ“° Crop News & Alerts', liveTag: 'Live',
  },
  hi: {
    aiOnline: 'AI à¤‘à¤¨à¤²à¤¾à¤‡à¤¨', langBtn: 'ğŸŒ à¤¹à¤¿à¤¨à¥à¤¦à¥€ / EN', chatTitle: 'à¤«à¤¸à¤² AI à¤¸à¤¹à¤¾à¤¯à¤•',
    chatSubtitle: 'à¤«à¤¸à¤² à¤°à¥‹à¤— à¤ªà¤¹à¤šà¤¾à¤¨ Â· à¤‰à¤ªà¤šà¤¾à¤° à¤¸à¤²à¤¾à¤¹ Â· à¤›à¤µà¤¿ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
    histBtn: 'ğŸ“‹ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸', transBtn: 'ğŸŒ à¤­à¤¾à¤·à¤¾', uploadBtn: 'ğŸ“¸ à¤«à¤¸à¤² à¤«à¥‹à¤Ÿà¥‹ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚',
    analyzeBtn: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‡à¤‚ â¤', previewSize: 'AI à¤°à¥‹à¤— à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤¤à¥ˆà¤¯à¤¾à¤°', newScan: '+ à¤¨à¤ˆ à¤¸à¥à¤•à¥ˆà¤¨',
    transModalTitle: 'à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚', translateNote: 'à¤­à¤¾à¤·à¤¾ à¤¬à¤¦à¤²à¤¨à¥‡ à¤¸à¥‡ à¤‡à¤‚à¤Ÿà¤°à¤«à¤¼à¥‡à¤¸ à¤”à¤° à¤¸à¤­à¥€ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤…à¤¨à¥à¤µà¤¾à¤¦à¤¿à¤¤ à¤¹à¥‹ à¤œà¤¾à¤à¤‚à¤—à¥‡à¥¤',
    transClose: 'à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚', newsTitle: 'ğŸ“° à¤«à¤¸à¤² à¤¸à¤®à¤¾à¤šà¤¾à¤° à¤”à¤° à¤…à¤²à¤°à¥à¤Ÿ', liveTag: 'à¤²à¤¾à¤‡à¤µ',
  }
};

const chatTranslations = {
  en: {
    welcome: `ğŸŒ± <strong>Namaste, Farmer!</strong> I'm Fasal AI, your digital crop doctor.<br><br>
      ğŸ“¸ <strong>Disease Detection</strong> â€” Upload a photo of your crop<br>
      ğŸ’Š <strong>Treatment Plans</strong> â€” Get medicine &amp; pesticide advice<br>
      ğŸŒ¦ï¸ <strong>Weather &amp; Seasonal Tips</strong><br><br>
      Tap ğŸ“° for crop news &amp; alerts, or upload a photo below!`,
    imgResponse: "I've scanned your uploaded image using AI disease detection. Here's my diagnosis:",
    userMsg: 'Please analyze this crop image for diseases.',
    diagnosisTag: 'ğŸ”¬ AI Diagnosis', confidence: 'Confidence',
    diagnosisName: 'Alternaria Leaf Blight',
    diagnosisDesc: 'Brown concentric ring spots on leaves. Common in onion, carrot. Recommend Mancozeb 75% WP at 2g/L water, apply weekly for 3 weeks.',
    langSwitchMsg: `ğŸŒ <strong>Language set to English.</strong> All messages are now in English.`,
    routineTitle: '7-Day Recovery Routine',
  },
  hi: {
    welcome: `ğŸŒ± <strong>à¤¨à¤®à¤¸à¥à¤¤à¥‡, à¤•à¤¿à¤¸à¤¾à¤¨ à¤­à¤¾à¤ˆ!</strong> à¤®à¥ˆà¤‚ à¤«à¤¸à¤² AI à¤¹à¥‚à¤, à¤†à¤ªà¤•à¤¾ à¤¡à¤¿à¤œà¤¿à¤Ÿà¤² à¤«à¤¸à¤² à¤¡à¥‰à¤•à¥à¤Ÿà¤°à¥¤<br><br>
      ğŸ“¸ <strong>à¤°à¥‹à¤— à¤ªà¤¹à¤šà¤¾à¤¨</strong> â€” à¤…à¤ªà¤¨à¥€ à¤«à¤¸à¤² à¤•à¥€ à¤«à¥‹à¤Ÿà¥‹ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚<br>
      ğŸ’Š <strong>à¤‰à¤ªà¤šà¤¾à¤° à¤¯à¥‹à¤œà¤¨à¤¾</strong> â€” à¤¦à¤µà¤¾à¤ˆ à¤”à¤° à¤•à¥€à¤Ÿà¤¨à¤¾à¤¶à¤• à¤•à¥€ à¤¸à¤²à¤¾à¤¹ à¤ªà¤¾à¤à¤‚<br>
      ğŸŒ¦ï¸ <strong>à¤®à¥Œà¤¸à¤® à¤”à¤° à¤®à¥Œà¤¸à¤®à¥€ à¤¸à¥à¤à¤¾à¤µ</strong><br><br>
      ğŸ“° à¤¸à¤®à¤¾à¤šà¤¾à¤° à¤”à¤° à¤…à¤²à¤°à¥à¤Ÿ à¤•à¥‡ à¤²à¤¿à¤, à¤¯à¤¾ à¤¨à¥€à¤šà¥‡ à¤«à¥‹à¤Ÿà¥‹ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚!`,
    imgResponse: 'à¤®à¥ˆà¤‚à¤¨à¥‡ à¤†à¤ªà¤•à¥€ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¥€ à¤—à¤ˆ à¤›à¤µà¤¿ à¤•à¥‹ AI à¤°à¥‹à¤— à¤ªà¤¹à¤šà¤¾à¤¨ à¤¸à¥‡ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤¿à¤¯à¤¾ à¤¹à¥ˆà¥¤ à¤¯à¤¹à¤¾à¤ à¤®à¥‡à¤°à¤¾ à¤¨à¤¿à¤¦à¤¾à¤¨ à¤¹à¥ˆ:',
    userMsg: 'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤‡à¤¸ à¤«à¤¸à¤² à¤›à¤µà¤¿ à¤®à¥‡à¤‚ à¤°à¥‹à¤—à¥‹à¤‚ à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‡à¤‚à¥¤',
    diagnosisTag: 'ğŸ”¬ AI à¤¨à¤¿à¤¦à¤¾à¤¨', confidence: 'à¤µà¤¿à¤¶à¥à¤µà¤¾à¤¸',
    diagnosisName: 'à¤…à¤²à¥à¤Ÿà¤°à¤¨à¥‡à¤°à¤¿à¤¯à¤¾ à¤ªà¤¤à¥à¤¤à¥€ à¤à¥à¤²à¤¸à¤¾',
    diagnosisDesc: 'à¤ªà¤¤à¥à¤¤à¤¿à¤¯à¥‹à¤‚ à¤ªà¤° à¤­à¥‚à¤°à¥‡ à¤—à¥‹à¤²à¤¾à¤•à¤¾à¤° à¤§à¤¬à¥à¤¬à¥‡à¥¤ à¤ªà¥à¤¯à¤¾à¤œ, à¤—à¤¾à¤œà¤° à¤®à¥‡à¤‚ à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯à¥¤ à¤®à¥ˆà¤¨à¤•à¥‹à¤œà¥‡à¤¬ 75% WP 2g/L à¤ªà¤¾à¤¨à¥€ à¤®à¥‡à¤‚ à¤®à¤¿à¤²à¤¾à¤•à¤°, 3 à¤¸à¤ªà¥à¤¤à¤¾à¤¹ à¤¤à¤• à¤¸à¤¾à¤ªà¥à¤¤à¤¾à¤¹à¤¿à¤• à¤›à¤¿à¤¡à¤¼à¤•à¤¾à¤µ à¤•à¤°à¥‡à¤‚à¥¤',
    langSwitchMsg: `ğŸŒ <strong>à¤­à¤¾à¤·à¤¾ à¤¹à¤¿à¤¨à¥à¤¦à¥€ à¤®à¥‡à¤‚ à¤¸à¥‡à¤Ÿ à¤•à¥€ à¤—à¤ˆà¥¤</strong> à¤¸à¤­à¥€ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤…à¤¬ à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¹à¥ˆà¤‚à¥¤`,
    routineTitle: '7-à¤¦à¤¿à¤µà¤¸à¥€à¤¯ à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤¦à¤¿à¤¨à¤šà¤°à¥à¤¯à¤¾',
  }
};

function applyUILanguage(lang) {
  const s = uiStrings[lang];
  try { document.querySelector('.status-dot + span').textContent = s.aiOnline; } catch(e){}
  try { document.querySelector('.nav-right .nav-btn.outline:not(#newsNavBtn)').textContent = s.langBtn; } catch(e){}
  try { document.getElementById('translateBtn').textContent = s.transBtn; } catch(e){}
  try {
    const hBtns = document.querySelectorAll('.chat-header > div:last-child .nav-btn');
    if (hBtns[0]) hBtns[0].textContent = s.histBtn;
    if (hBtns[1]) hBtns[1].textContent = s.transBtn;
  } catch(e){}
  try { document.querySelector('.chat-title').textContent = s.chatTitle; } catch(e){}
  try { document.querySelector('.chat-subtitle').textContent = s.chatSubtitle; } catch(e){}
  try { document.getElementById('imgBtn').innerHTML = s.uploadBtn; } catch(e){}
  try { document.querySelector('.preview-size').textContent = s.previewSize; } catch(e){}
  try { document.querySelector('.preview-send').textContent = s.analyzeBtn; } catch(e){}
  try { document.querySelector('.nav-btn.primary').textContent = s.newScan; } catch(e){}
  try { document.querySelector('#panelLeft .sidebar-title').textContent = s.newsTitle; } catch(e){}
  try { document.querySelector('#panelLeft .sidebar-header .tag-pill.active').textContent = s.liveTag; } catch(e){}
  try { document.getElementById('transModalTitle').textContent = s.transModalTitle; } catch(e){}
  try { document.getElementById('translateNote').textContent = s.translateNote; } catch(e){}
  try { document.getElementById('transCloseBtn').textContent = s.transClose; } catch(e){}
  try {
    document.querySelectorAll('.read-aloud-btn:not(.speaking)').forEach(btn => {
      btn.innerHTML = `<span class="speaker-icon">ğŸ”Š</span> ${lang === 'hi' ? 'à¤œà¥‹à¤° à¤¸à¥‡ à¤ªà¤¢à¤¼à¥‡à¤‚' : 'Read Aloud'}`;
    });
  } catch(e){}
  // Routine titles
  try {
    document.querySelectorAll('.routine-title').forEach(el => {
      el.textContent = chatTranslations[lang].routineTitle;
    });
  } catch(e){}
}

// â”€â”€ Translate all rendered routine cards to the given language â”€â”€
function translateRoutineCards(lang) {
  const days = routineData[lang] || routineData.en;
  const t = chatTranslations[lang] || chatTranslations.en;
  const isHi = lang === 'hi';
  const todayWord = isHi ? 'à¤†à¤œ' : 'TODAY';
  const progressLabel = isHi ? 'à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤²à¤¾à¤­ à¤ªà¥à¤°à¤—à¤¤à¤¿' : 'Recovery Progress';
  const daysWord = isHi ? 'à¤¦à¤¿à¤¨' : 'days';
  const resetLabel = isHi ? 'â†º à¤°à¥€à¤¸à¥‡à¤Ÿ' : 'â†º Reset';
  const diagSubtitle = isHi ? `${t.diagnosisName} à¤•à¥‡ à¤²à¤¿à¤` : `Tailored for ${t.diagnosisName}`;

  document.querySelectorAll('.routine-card').forEach(card => {
    const cardId = card.id;
    // Update language attribute
    card.dataset.lang = lang;

    // Header texts
    const rt = card.querySelector('.routine-title');
    if (rt) rt.textContent = t.routineTitle;
    const rs = card.querySelector('.routine-subtitle');
    if (rs) rs.textContent = diagSubtitle;

    // Rebuild day rows with new language
    const grid = document.getElementById(cardId + '_grid');
    const savedState = loadRoutineState(cardId);
    if (grid) {
      grid.innerHTML = days.map((d, i) => {
        const isDone = savedState.done.includes(d.day);
        const isToday = !isDone && savedState.done.length === i;
        return `
          <div class="day-row ${isDone ? 'done' : ''} ${isToday ? 'today' : ''}" id="${cardId}_day${d.day}" onclick="toggleDay('${cardId}', ${d.day})">
            <div class="day-number">${isHi ? 'à¤¦à¤¿' : 'D'}${d.day}</div>
            <div class="day-info">
              <div class="day-title">
                ${d.emoji} ${d.title}
                ${isToday ? `<span class="today-badge">${todayWord}</span>` : ''}
              </div>
              <div class="day-desc">${d.desc}</div>
            </div>
            <span class="day-tag ${d.tag}">${d.tagLabel}</span>
            <div class="day-check">${isDone ? 'âœ“' : ''}</div>
          </div>`;
      }).join('');
    }

    // Footer
    const pl = document.getElementById(cardId + '_progressLabel');
    if (pl) pl.textContent = progressLabel;
    const pctLabel = document.getElementById(cardId + '_pctLabel');
    if (pctLabel) {
      const doneCount = savedState.done.length;
      const pct = Math.round((doneCount / days.length) * 100);
      pctLabel.textContent = `${doneCount}/${days.length} ${daysWord} Â· ${pct}%`;
    }
    const rb = document.getElementById(cardId + '_resetBtn');
    if (rb) rb.textContent = resetLabel;
  });
}

function translateChatMessages(lang) {
  const t = chatTranslations[lang];
  const msgs = document.getElementById('chatMessages');
  let aiIdx = 0;
  Array.from(msgs.children).forEach(wrapper => {
    const bubble = wrapper.querySelector('.msg-bubble');
    if (!bubble) return;
    const isUser = wrapper.querySelector('.msg.user');
    const isAI = wrapper.querySelector('.msg.ai');
    if (isUser) {
      const imgPart = bubble.querySelector('.msg-image-preview');
      bubble.innerHTML = '';
      if (imgPart) bubble.appendChild(imgPart);
      bubble.insertAdjacentText('beforeend', t.userMsg);
    }
    if (isAI) {
      // Pull out live DOM nodes BEFORE touching innerHTML so IDs are preserved
      const diagCard = bubble.querySelector('.diagnosis-card');
      const routineCard = bubble.querySelector('.routine-card');

      // Translate diagnosis card in-place (no innerHTML replacement needed)
      if (diagCard) {
        try { diagCard.querySelector('.diagnosis-tag').textContent = t.diagnosisTag; } catch(e){}
        try { diagCard.querySelector('.diagnosis-name').textContent = t.diagnosisName; } catch(e){}
        try { diagCard.querySelector('.diagnosis-detail').textContent = t.diagnosisDesc; } catch(e){}
        try { const cl = diagCard.querySelectorAll('.conf-label'); if (cl[0]) cl[0].textContent = t.confidence; } catch(e){}
      }

      // Rebuild only the text prefix of the bubble, then re-attach card nodes
      const raw = bubble.innerHTML;
      let newText = null;
      if (aiIdx === 0) {
        newText = t.welcome;
      } else if (raw.includes('scanned') || raw.includes('diagnosis') || raw.includes('à¤¸à¥à¤•à¥ˆà¤¨') || raw.includes('à¤¨à¤¿à¤¦à¤¾à¤¨')) {
        newText = t.imgResponse;
      } else if (raw.includes('Language set') || raw.includes('à¤­à¤¾à¤·à¤¾')) {
        bubble.innerHTML = t.langSwitchMsg;
        aiIdx++;
        return;
      }

      if (newText !== null) {
        // Detach the card nodes first so they survive the innerHTML reset
        if (diagCard) diagCard.remove();
        if (routineCard) routineCard.remove();
        bubble.innerHTML = newText;
        if (diagCard) bubble.appendChild(diagCard);
        if (routineCard) bubble.appendChild(routineCard);
      }

      aiIdx++;
    }
  });
  // Now translate all routine cards in-place (IDs are still intact in DOM)
  translateRoutineCards(lang);
}

const uiSource = {
  aiOnline:'AI Online', langBtn:'ğŸŒ Language', chatTitle:'Fasal AI Assistant',
  chatSubtitle:'Crop Disease Detection Â· Treatment Advice Â· Image Analysis',
  histBtn:'ğŸ“‹ History', transBtn:'ğŸŒ Translate', uploadBtn:'ğŸ“¸ Upload Crop Photo',
  analyzeBtn:'Analyze â¤', previewSize:'Ready for AI disease analysis', newScan:'+ New Scan',
  transModalTitle:'Select Language', translateNote:'Switching language will translate the interface and all chat messages.',
  transClose:'Cancel', newsTitle:'ğŸ“° Crop News & Alerts', liveTag:'Live',
  readAloud:'ğŸ”Š Read Aloud', routineTitle:'7-Day Recovery Routine',
  welcomeMsg:`ğŸŒ± <strong>Namaste, Farmer!</strong> I'm Fasal AI, your digital crop doctor.<br><br>ğŸ“¸ <strong>Disease Detection</strong> â€” Upload a photo of your crop<br>ğŸ’Š <strong>Treatment Plans</strong> â€” Get medicine & pesticide advice<br>ğŸŒ¦ï¸ <strong>Weather & Seasonal Tips</strong><br><br>Tap ğŸ“° for crop news & alerts, or upload a photo below!`,
  imgResponse:"I've scanned your uploaded image using AI disease detection. Here's my diagnosis:",
  userMsg:'Please analyze this crop image for diseases.',
  diagnosisTag:'ğŸ”¬ AI Diagnosis', confidence:'Confidence',
  diagnosisName:'Alternaria Leaf Blight',
  diagnosisDesc:'Brown concentric ring spots on leaves. Common in onion, carrot. Recommend Mancozeb 75% WP at 2g/L water, apply weekly for 3 weeks.',
};

const translationCache = { en: uiStrings.en, hi: uiStrings.hi };

function showTranslateLoading(langObj) {
  const body = document.querySelector('#translateModal .modal-body');
  body._origHTML = body.innerHTML;
  body.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 20px;gap:16px;">
    <div style="width:42px;height:42px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
    <div style="font-size:0.9rem;font-weight:600;color:var(--text);">${langObj.flag} Translating to ${langObj.name}...</div>
    <div style="font-size:0.75rem;color:var(--muted);text-align:center;">Translating entire interface<br>using AI â€” just a moment</div>
  </div>
  <style>@keyframes spin{to{transform:rotate(360deg)}}</style>`;
}

function hideTranslateLoading() {
  const body = document.querySelector('#translateModal .modal-body');
  if (body._origHTML) { body.innerHTML = body._origHTML; body._origHTML = null; }
}

async function fetchTranslation(langObj) {
  if (translationCache[langObj.code]) return translationCache[langObj.code];
  const prompt = `You are a professional translator. Translate the following JSON object's string values into ${langObj.name} (${langObj.native}).
Rules: Keep ALL keys exactly as-is. Keep emojis exactly as-is. Keep HTML tags exactly as-is. Keep â¤ as-is. Translate ONLY text portions. Return ONLY valid JSON, no markdown.
JSON: ${JSON.stringify(uiSource, null, 2)}`;
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, messages: [{ role: 'user', content: prompt }] })
  });
  const data = await response.json();
  const text = data.content?.[0]?.text || '{}';
  const clean = text.replace(/```json|```/g, '').trim();
  try {
    const translated = JSON.parse(clean);
    const merged = { ...uiSource, ...translated };
    translationCache[langObj.code] = merged;
    return merged;
  } catch(e) { return uiSource; }
}

async function setLanguage(lang) {
  if (lang === currentLang) { closeModal('translateModal'); return; }
  const langObj = allLanguages.find(l => l.code === lang) || { name: lang, native: lang, flag: 'ğŸŒ', code: lang };
  if (uiStrings[lang]) {
    currentLang = lang;
    applyUILanguage(lang);
    translateChatMessages(lang);
    appendAIMessage(chatTranslations[lang].langSwitchMsg);
    closeModal('translateModal');
    return;
  }
  showTranslateLoading(langObj);
  try {
    const t = await fetchTranslation(langObj);
    currentLang = lang;
    hideTranslateLoading();
    // Apply generic translation
    try { document.querySelector('.status-dot + span').textContent = t.aiOnline; } catch(e){}
    try { document.querySelector('.nav-right .nav-btn.outline:not(#newsNavBtn)').textContent = t.langBtn; } catch(e){}
    try { document.getElementById('translateBtn').textContent = t.transBtn; } catch(e){}
    try { document.querySelector('.chat-title').textContent = t.chatTitle; } catch(e){}
    try { document.querySelector('.chat-subtitle').textContent = t.chatSubtitle; } catch(e){}
    try { document.getElementById('imgBtn').innerHTML = t.uploadBtn; } catch(e){}
    try { document.querySelector('.preview-size').textContent = t.previewSize; } catch(e){}
    try { document.querySelector('.preview-send').textContent = t.analyzeBtn; } catch(e){}
    try { document.querySelector('.nav-btn.primary').textContent = t.newScan; } catch(e){}
    try { document.querySelector('#panelLeft .sidebar-title').textContent = t.newsTitle; } catch(e){}
    try { document.getElementById('transModalTitle').textContent = t.transModalTitle; } catch(e){}
    try { document.getElementById('translateNote').textContent = t.translateNote; } catch(e){}
    try { document.getElementById('transCloseBtn').textContent = t.transClose; } catch(e){}
    try { document.querySelectorAll('.routine-title').forEach(el => { el.textContent = t.routineTitle || '7-Day Recovery Routine'; }); } catch(e){}
    appendAIMessage(`${langObj.flag} <strong>${t.chatTitle}</strong> â€” ${(t.translateNote||'').split('.')[0]}. âœ“`);
  } catch(err) {
    hideTranslateLoading();
    currentLang = lang;
    appendAIMessage(`${langObj.flag} <strong>Language set to ${langObj.name} (${langObj.native}).</strong> Full translation unavailable â€” showing English interface.`);
  }
  closeModal('translateModal');
}

const allLanguages = [
  { code:'hi', flag:'ğŸ‡®ğŸ‡³', name:'Hindi', native:'à¤¹à¤¿à¤¨à¥à¤¦à¥€', group:'Indian' },
  { code:'mr', flag:'ğŸ‡®ğŸ‡³', name:'Marathi', native:'à¤®à¤°à¤¾à¤ à¥€', group:'Indian' },
  { code:'pa', flag:'ğŸ‡®ğŸ‡³', name:'Punjabi', native:'à¨ªà©°à¨œà¨¾à¨¬à©€', group:'Indian' },
  { code:'gu', flag:'ğŸ‡®ğŸ‡³', name:'Gujarati', native:'àª—à«àªœàª°àª¾àª¤à«€', group:'Indian' },
  { code:'bn', flag:'ğŸ‡®ğŸ‡³', name:'Bengali', native:'à¦¬à¦¾à¦‚à¦²à¦¾', group:'Indian' },
  { code:'ta', flag:'ğŸ‡®ğŸ‡³', name:'Tamil', native:'à®¤à®®à®¿à®´à¯', group:'Indian' },
  { code:'te', flag:'ğŸ‡®ğŸ‡³', name:'Telugu', native:'à°¤à±†à°²à±à°—à±', group:'Indian' },
  { code:'kn', flag:'ğŸ‡®ğŸ‡³', name:'Kannada', native:'à²•à²¨à³à²¨à²¡', group:'Indian' },
  { code:'ml', flag:'ğŸ‡®ğŸ‡³', name:'Malayalam', native:'à´®à´²à´¯à´¾à´³à´‚', group:'Indian' },
  { code:'or', flag:'ğŸ‡®ğŸ‡³', name:'Odia', native:'à¬“à¬¡à¬¼à¬¿à¬†', group:'Indian' },
  { code:'as', flag:'ğŸ‡®ğŸ‡³', name:'Assamese', native:'à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾', group:'Indian' },
  { code:'ur', flag:'ğŸ‡®ğŸ‡³', name:'Urdu', native:'Ø§Ø±Ø¯Ùˆ', group:'Indian' },
  { code:'ne', flag:'ğŸ‡³ğŸ‡µ', name:'Nepali', native:'à¤¨à¥‡à¤ªà¤¾à¤²à¥€', group:'Indian' },
  { code:'si', flag:'ğŸ‡±ğŸ‡°', name:'Sinhala', native:'à·ƒà·’à¶‚à·„à¶½', group:'Indian' },
  { code:'en', flag:'ğŸ‡¬ğŸ‡§', name:'English', native:'English', group:'European' },
  { code:'fr', flag:'ğŸ‡«ğŸ‡·', name:'French', native:'FranÃ§ais', group:'European' },
  { code:'de', flag:'ğŸ‡©ğŸ‡ª', name:'German', native:'Deutsch', group:'European' },
  { code:'es', flag:'ğŸ‡ªğŸ‡¸', name:'Spanish', native:'EspaÃ±ol', group:'European' },
  { code:'pt', flag:'ğŸ‡µğŸ‡¹', name:'Portuguese', native:'PortuguÃªs', group:'European' },
  { code:'it', flag:'ğŸ‡®ğŸ‡¹', name:'Italian', native:'Italiano', group:'European' },
  { code:'ru', flag:'ğŸ‡·ğŸ‡º', name:'Russian', native:'Ğ ÑƒÑÑĞºĞ¸Ğ¹', group:'European' },
  { code:'zh', flag:'ğŸ‡¨ğŸ‡³', name:'Chinese (Simplified)', native:'ä¸­æ–‡ (ç®€ä½“)', group:'East Asian' },
  { code:'ja', flag:'ğŸ‡¯ğŸ‡µ', name:'Japanese', native:'æ—¥æœ¬èª', group:'East Asian' },
  { code:'ko', flag:'ğŸ‡°ğŸ‡·', name:'Korean', native:'í•œêµ­ì–´', group:'East Asian' },
  { code:'id', flag:'ğŸ‡®ğŸ‡©', name:'Indonesian', native:'Bahasa Indonesia', group:'Southeast Asian' },
  { code:'th', flag:'ğŸ‡¹ğŸ‡­', name:'Thai', native:'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢', group:'Southeast Asian' },
  { code:'vi', flag:'ğŸ‡»ğŸ‡³', name:'Vietnamese', native:'Tiáº¿ng Viá»‡t', group:'Southeast Asian' },
  { code:'ar', flag:'ğŸ‡¸ğŸ‡¦', name:'Arabic', native:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', group:'Middle Eastern' },
  { code:'tr', flag:'ğŸ‡¹ğŸ‡·', name:'Turkish', native:'TÃ¼rkÃ§e', group:'Middle Eastern' },
  { code:'fa', flag:'ğŸ‡®ğŸ‡·', name:'Persian', native:'ÙØ§Ø±Ø³ÛŒ', group:'Middle Eastern' },
  { code:'he', flag:'ğŸ‡®ğŸ‡±', name:'Hebrew', native:'×¢×‘×¨×™×ª', group:'Middle Eastern' },
  { code:'sw', flag:'ğŸŒ', name:'Swahili', native:'Kiswahili', group:'African' },
  { code:'am', flag:'ğŸ‡ªğŸ‡¹', name:'Amharic', native:'áŠ áˆ›áˆ­áŠ›', group:'African' },
  { code:'pt-BR', flag:'ğŸ‡§ğŸ‡·', name:'Portuguese (Brazil)', native:'PortuguÃªs (Brasil)', group:'Americas' },
  { code:'es-MX', flag:'ğŸ‡²ğŸ‡½', name:'Spanish (Mexico)', native:'EspaÃ±ol (MÃ©xico)', group:'Americas' },
  { code:'eo', flag:'ğŸŒ', name:'Esperanto', native:'Esperanto', group:'Other' },
];

function renderLangList(filter='') {
  const list = document.getElementById('langList');
  const q = filter.toLowerCase();
  const filtered = q ? allLanguages.filter(l =>
    l.name.toLowerCase().includes(q) || l.native.toLowerCase().includes(q) || l.code.toLowerCase().includes(q)
  ) : allLanguages;
  if (filtered.length === 0) {
    list.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);font-size:0.85rem;">No language found</div>`;
    return;
  }
  const groups = q ? {'Results': filtered} : filtered.reduce((acc, l) => {
    acc[l.group] = acc[l.group] || []; acc[l.group].push(l); return acc;
  }, {});
  const groupOrder = ['Indian','European','East Asian','Southeast Asian','Middle Eastern','African','Americas','Other','Results'];
  list.innerHTML = groupOrder.filter(g => groups[g]).map(g => `
    <div style="font-family:'Space Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;padding:8px 4px 5px;">${g}</div>
    ${groups[g].map(l => `
      <div class="lang-option ${currentLang === l.code ? 'selected' : ''}" onclick="setLanguage('${l.code}')">
        <span class="lang-flag" style="font-size:1.4rem;">${l.flag}</span>
        <div><div class="lang-name">${l.name}</div><div class="lang-native">${l.native}</div></div>
        <span class="lang-check">âœ“</span>
      </div>`).join('')}
  `).join('');
}

function filterLangs(val) { renderLangList(val); }

function openTranslate() {
  document.getElementById('langSearch').value = '';
  renderLangList('');
  const s = uiStrings[currentLang];
  if (s) {
    document.getElementById('transModalTitle').textContent = s.transModalTitle;
    document.getElementById('translateNote').textContent = s.translateNote;
    document.getElementById('transCloseBtn').textContent = s.transClose;
  }
  openModal('translateModal');
  setTimeout(() => {
    const sel = document.querySelector('.lang-option.selected');
    if (sel) sel.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }, 50);
}

document.querySelector('.nav-right .nav-btn.outline:not(#newsNavBtn)').addEventListener('click', openTranslate);
</script>
</body>
</html>
